<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');


        body {
  font-family: 'Inter', sans-serif;
  /* deep navy radial gradient background */
  background: radial-gradient(circle at 10% 10%, #12203b 0%, #07102a 30%, #05071a 100%);
  color: #000000;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  margin: 0;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
        .page-section {
            display: none;
            padding-bottom: 7rem; /* Space for the navbar */
        }
        .page-section.active {
            display: block;
        }
        .navbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #1E293B;
            border-top: 1px solid #334155;
            z-index: 1000;
        }
        .navbar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 0;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            color: #94A3B8;
        }
        .navbar-item.active {
            color: #38BDF8;
            background-color: #121A26;
        }

        /* Wrapper */
.bingo-wrapper {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 1.5rem;
  background: #0f172a;
  border-radius: 1rem;
  box-shadow: 0 8px 20px rgba(0,0,0,0.4);
  color: white;
}

/* Grid = headers + numbers */
.bingo-grid {
  display: grid;
  grid-template-columns: repeat(5, 3rem); /* same width for headers & cells */
  grid-auto-rows: 3rem;
  gap: 0.5rem;
  background: #1e293b;
  padding: 1rem;
  border-radius: 0.75rem;
}

/* Header cells */
.bingo-header {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.6rem;
  font-weight: 900;
  letter-spacing: 2px;
}

.bingo-header.orange { color: #fb923c; }
.bingo-header.red    { color: #ef4444; }
.bingo-header.yellow { color: #facc15; }
.bingo-header.green  { color: #22c55e; }
.bingo-header.purple { color: #a855f7; }

/* Number cells */
.bingo-cell {
  display: flex;
  align-items: center;
  justify-content: center;
  background: #0f172a;
  border: 2px solid #334155;
  border-radius: 0.4rem;
  font-size: 1.1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s ease;
  user-select: none;
}

.bingo-cell:hover {
  background: #1e293b;
  transform: scale(1.05);
}

/* Free space */
.free-space {
  background: #22c55e !important;
  color: white !important;
}

/* Marked */
.marked {
  background: #0f172a;
  color: #22c55e;
  font-size: 1.5rem;
}
#game-section h1 {
  display: none !important;
}

        .card-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 1rem;
            max-height: 50vh;
            overflow-y: auto;
        }
        .card-selection-item {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 60px;
            height: 60px;
            background-color: #1E293B;
            border-radius: 0.2rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .card-selection-item.selected {
            background-color: #38BDF8;
            color: #0F172A;
        }
        .long-board-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            padding: 1rem;
            background-color: #1E293B;
            border-radius: 0.75rem;
        }
        .long-board-number {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 40px;
            width: 40px;
            border-radius: 50%;
            background-color: #334155;
        }
        .long-board-number.marked {
            background-color: #6EE7B7;
            color: #1E293B;
            font-weight: bold;
        }
        .called-number-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #FFFFFF;
            color: #0F172A;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
            font-weight: bold;
        }
        .message-box {
            position: fixed;
            bottom: 6rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            color: white;
            z-index: 2000;
            transition: opacity 0.5s ease-in-out;
            opacity: 0;
            animation: fadeInOut 5s forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }
        .admin-dashboard-btn {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1001;
        }

       /* Info box small tweak */
#game-info-box { 
  backdrop-filter: blur(4px); 
}
#game-info-box .grid div { 
  min-height: 44px;
  display:flex; 
  flex-direction:column; 
  justify-content:center;
}
#game-info-box div .text-gray-400 { font-size: 12px; }
#game-info-box div .font-bold { font-size: 16px; }
.card-selection-item {
    padding: 10px;
    border: 2px solid #4cafef;
    border-radius: 6px;
    text-align: center;
    cursor: pointer;
    background: #1e293b;
    color: white;
}

.card-selection-item:hover {
    background: #334155;
}

.card-selection-item.taken-card {
    background: #ef4444;
    color: white;
    cursor: not-allowed;
    opacity: 0.8;
}

.banner {
  position: relative;
  border-radius: 16px;
  overflow: hidden;
}
.banner::after {
  content: "";
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
}
   
 </style>
</head>
<body class="bg-slate-900 text-slate-100 flex flex-col items-center">

<header class="fixed top-0 left-0 w-full bg-slate-800 text-white flex items-center p-4 z-50 shadow-md h-12">

  <!-- Hamburger Button on the Left -->
  <button id="hamburger-btn" class="sm:hidden focus:outline-none mr-2 flex flex-col justify-center h-full">
    <div class="w-6 h-0.5 bg-white mb-1"></div>
    <div class="w-6 h-0.5 bg-white mb-1"></div>
    <div class="w-6 h-0.5 bg-white"></div>
  </button> 
   <button onclick="window.history.back()" class="back-btn">â¬… Back</button>

  <!-- Left Separator line -->
  <div class="border-l border-slate-600 h-10 self-center"></div>

  <!-- Logo with right separator line -->
  <div class="logo-container flex items-center mx-4 h-full">
    <div class="flex items-center h-full">
      <img src="logo6.png" alt="Top Bingo Logo" class="h-12 w-auto object-contain">
    </div>
    <!-- Right separator line -->
    <div class="border-r border-slate-600 h-10 self-center ml-4"></div>
  </div>

  <!-- Search icon always visible -->
  <button class="text-white mr-6">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 1110.5 3a7.5 7.5 0 016.15 13.65z" />
    </svg>
  </button>

  <!-- Right Side: Login & Register -->
  <div class="ml-auto flex items-center space-x-6">
    <a href="#" class="text-sm uppercase tracking-wide hover:underline">LOGIN</a>
    <button class="px-2 py-2 bg-cyan-500 hover:bg-blue-400 text-black rounded-lg text-sm font-semibold uppercase">
      DEPOSIT
    </button>
  </div>

  <!-- Optional Menu Items (hidden on mobile) -->
  <!-- Mobile Dropdown Menu -->
<div id="hamburger-menu" class="hidden absolute top-14 left-4 bg-slate-700 w-48 rounded-lg shadow-lg flex flex-col p-2 sm:hidden">
  <a href="#" class="px-4 py-2 hover:bg-cyan-500 rounded" data-page="game-section">Home</a>
  <a href="#" class="px-4 py-2 hover:bg-cyan-500 rounded" data-page="rules-section">Rules</a>
  <a href="#" class="px-4 py-2 hover:bg-cyan-500 rounded" data-page="profile-section">Profile</a>
</div>
</header>
     
    <main class="container mx-auto p-4 flex-grow w-full max-w-lg">
        <!-- Game Section -->
        <div id="game-section" class="page-section active pt-4"
             
 <!-- Room Selection -->
<div id="room-selection-container" class="flex flex-col gap-2 mt-4 max-w-2xl mx-auto">
<div class="w-full mt-2">
  <img src="banner3.png" alt="Bingo Banner" class="w-full max-w-full h-auto object-contain rounded-lg mx-auto" />
</div>
  <!-- Header -->
  <div class="bg-slate-900 rounded-2xl shadow-md grid grid-cols-4 text-center p-2 font-bold text-white text-lg">
    <div>Room</div>
    <div>Time</div>
    <div>Win</div>
    <div>Join</div>
  </div>

   <!-- ðŸ’° Room 10 -->
<div class="room-card bg-slate-800 rounded-2xl shadow-md grid grid-cols-4 items-center text-center p-2  
  transition-all duration-300 hover:scale-105 hover:shadow-[0_0_20px_3px_rgba(255,255,255,0.2)]"  
  data-room="room_10"> 
  <div class="text-white font-semibold text-lg">10 Br</div>

  <!-- Time / Player area -->
  <div class="text-red-400">
    <span class="countdown text-sm text-red-400" data-room="room_10">--</span>
  </div>

  <div class="text-cyan-400 font-semibold">
    <span class="jackpot-display" data-room="room_10">0</span> Br
  </div>

  <button class="border border-cyan-400 text-cyan-400 font-semibold py-1 px-3 rounded-xl 
    hover:bg-emerald-400 hover:text-slate-900 transition-all duration-300 
    hover:shadow-[0_0_15px_3px_rgba(16,185,129,0.4)]">
    Join  >>
  </button>
</div>  

  <!-- ðŸ’° Room 20 -->
<div class="room-card bg-slate-800 rounded-2xl shadow-md grid grid-cols-4 items-center text-center p-2 
  transition-all duration-300 hover:scale-105 hover:shadow-[0_0_20px_3px_rgba(255,255,255,0.2)]" 
  data-room="room_20">

  <div class="text-white font-semibold text-lg">20 Br</div>

  <!-- Time / Player area -->
  <div class="text-red-400">
    <span class="countdown text-sm text-red-400" data-room="room_20">--</span>
  </div>

  <div class="text-cyan-400 font-semibold">
    <span class="jackpot-display" data-room="room_20">0</span> Br
  </div>

  <button class="border border-cyan-400 text-cyan-400 font-semibold py-1 px-3 rounded-xl 
    hover:bg-emerald-400 hover:text-slate-900 transition-all duration-300 
    hover:shadow-[0_0_15px_3px_rgba(16,185,129,0.4)]">
    Join >>
  </button>
</div>

  <!-- ðŸ’° Room 50 -->
<div class="room-card bg-slate-800 rounded-2xl shadow-md grid grid-cols-4 items-center text-center p-2 
  transition-all duration-300 hover:scale-105 hover:shadow-[0_0_20px_3px_rgba(255,255,255,0.2)]" 
  data-room="room_50">

  <div class="text-white font-semibold text-lg">50 Br</div>

  <!-- Time / Player area -->
  <div class="text-red-400">
    <span class="countdown text-sm text-red-400" data-room="room_50">--</span>
  </div>

  <div class="text-cyan-400 font-semibold">
    <span class="jackpot-display" data-room="room_50">0</span> Br
  </div>

  <button class="border border-cyan-400 text-cyan-400 font-semibold py-1 px-3 rounded-xl 
    hover:bg-emerald-400 hover:text-slate-900 transition-all duration-300 
    hover:shadow-[0_0_15px_3px_rgba(16,185,129,0.4)]">
    Join >>
  </button>
</div>

<!-- ðŸ’° Room 100 -->
<div class="room-card bg-slate-800 rounded-2xl shadow-md grid grid-cols-4 items-center text-center p-2 
  transition-all duration-300 hover:scale-105 hover:shadow-[0_0_20px_3px_rgba(255,255,255,0.2)]" 
  data-room="room_100">

  <div class="text-white font-semibold text-lg">100 Br</div>

  <!-- Time / Player area -->
  <div class="text-red-400">
    <span class="countdown text-sm text-red-400" data-room="room_10">--</span>
  </div>

  <div class="text-cyan-400 font-semibold">
    <span class="jackpot-display" data-room="room_100">0</span> Br
  </div>

  <button class="border border-cyan-400 text-cyan-400 font-semibold py-1 px-3 rounded-xl 
    hover:bg-emerald-400 hover:text-slate-900 transition-all duration-300 
    hover:shadow-[0_0_15px_3px_rgba(16,185,129,0.4)]">
    Join >>
  </button>
</div>  

</div>
            <!-- Card Selection -->
            <div id="card-selection-container" class="hidden">
                <div id="card-selection-grid" class="card-selection-grid p-4 bg-slate-800 rounded-xl shadow-inner"></div>
                <div class="mt-4 flex flex-col items-center gap-2">
                    <p id="cards-selected-info" class="text-lg font-bold text-center">0/4 cards selected</p>
                    <button id="start-game-btn" class="w-full px-6 py-3 mt-4 text-lg font-bold text-white bg-blue-500 rounded-xl shadow-lg transition-colors hover:bg-blue-600 disabled:bg-gray-500" disabled>
                        Start Game
                    </button>
                </div>
            </div>

            <!-- Game Board -->
            <div id="game-board-container" class="hidden">
            <!-- Info Box (put at top of #game-board-container) -->
<div id="game-info-box" class="w-full bg-slate-800 rounded-xl shadow-md p-3 mb-4 text-sm text-center">
  <div class="grid grid-cols-4 gap-2">
    <div>
      <div class="text-gray-400">Players</div>
      <div id="info-players" class="text-white font-bold">0</div>
    </div>
    <div>
      <div class="text-gray-400">Amount</div>
      <div id="info-amount" class="text-green-400 font-bold">0</div>
    </div>
    <div>
      <div class="text-gray-400">Jackpot</div>
      <div id="info-jackpot" class="text-yellow-400 font-bold">0</div>
    </div>
    <div>
      <div class="text-gray-400">Called</div>
      <div id="info-called" class="text-sky-400 font-bold">0 / 75</div>
    </div>
  </div>
</div>              

  <div class="flex flex-col items-center">
                    <p id="game-status" class="text-xl font-bold mb-2 text-center text-blue-400">Waiting for players...</p>
                    <div class="flex items-center justify-center gap-4 mb-6">
                        <p class="text-gray-400 text-sm">Called Numbers: <span id="called-numbers-count" class="font-bold text-white">0</span>/75</p>
                    </div>
                    <div class="flex flex-col items-center mb-6">
                        <div id="called-number-circle" class="called-number-circle">00</div>
                        <p class="text-sm text-gray-400 mt-2">Latest Number</p>
                    </div>

                    <div id="cards-container" class="flex flex-col gap-4 w-full"></div>

                    <button id="bingo-btn" class="w-full px-6 py-3 mt-6 text-lg font-bold text-white bg-green-500 rounded-xl shadow-lg transition-colors hover:bg-green-600">
                        <i class="fas fa-star mr-2"></i> BINGO!
                    </button>
                </div>

                <div class="mt-8">
                    <h3 class="text-xl font-bold mb-4 text-center">Called Numbers</h3>
                    <div id="long-board" class="long-board-container"></div>
                </div>
            </div>
        </div>

        <!-- Wallet Section -->
        <div id="wallet-section" class="page-section pt-8">
            <h2 class="text-3xl font-bold text-center mb-4">Wallet</h2>
            <div class="flex items-center justify-between p-4 bg-slate-800 rounded-xl shadow-lg mb-6">
                <span class="text-lg text-gray-400">Your Balance:</span>
                <span id="wallet-balance" class="text-3xl font-bold text-green-400">0.00</span>
            </div>

            <div class="w-full max-w-sm mx-auto flex">
                <button id="deposit-tab-btn" class="flex-1 p-3 text-center rounded-tl-xl rounded-bl-xl transition-colors bg-slate-700 active-tab">
                    Deposit
                </button>
                <button id="withdraw-tab-btn" class="flex-1 p-3 text-center transition-colors bg-slate-700">
                    Withdraw
                </button>
                <button id="requests-tab-btn" class="flex-1 p-3 text-center rounded-tr-xl rounded-br-xl transition-colors bg-slate-700">
                    My Requests
                </button>
            </div>

            <div id="deposit-form-container" class="mt-4 p-6 bg-slate-800 rounded-xl shadow-lg active-tab-content">
                <h3 class="text-xl font-bold mb-2">Request Deposit</h3>
                <p class="text-sm text-gray-400 mb-4">Enter the amount you wish to deposit. An admin will approve it shortly.</p>
                <form id="deposit-form" class="flex flex-col gap-4">
                    <div>
                        <label for="deposit-amount" class="text-sm text-gray-400">Amount</label>
                        <input type="number" id="deposit-amount" class="w-full mt-1 p-3 bg-slate-700 rounded-lg outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="e.g. 50" min="1" required>
                    </div>
                    <div>
                       <label for="telebirr-message" class="text-sm text-gray-400 mt-4">Telebirr Message (optional)</label>
                       <input type="text" id="telebirr-message" class="w-full mt-1 p-3 bg-slate-700 rounded-lg outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="Enter your Telebirr message">
                     </div>
 
                    <button type="submit" class="w-full px-6 py-3 text-lg font-bold text-white bg-blue-500 rounded-xl shadow-lg transition-colors hover:bg-blue-600">
                        Request Deposit
                    </button>
                </form>
            </div>

            <div id="withdraw-form-container" class="mt-4 p-6 bg-slate-800 rounded-xl shadow-lg hidden">
                <h3 class="text-xl font-bold mb-2">Request Withdrawal</h3>
                <p class="text-sm text-gray-400 mb-4">Enter the amount you wish to withdraw.</p>
                <form id="withdraw-form" class="flex flex-col gap-4">
                    <div>
                        <label for="withdraw-amount" class="text-sm text-gray-400">Amount</label>
                        <input type="number" id="withdraw-amount" class="w-full mt-1 p-3 bg-slate-700 rounded-lg outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="e.g. 20" min="1" required>
                    </div>
                    <button type="submit" class="w-full px-6 py-3 text-lg font-bold text-white bg-yellow-500 rounded-xl shadow-lg transition-colors hover:bg-yellow-600">
                        Request Withdrawal
                    </button>
                </form>
            </div>

            <div id="requests-container" class="mt-4 p-6 bg-slate-800 rounded-xl shadow-lg hidden">
                <h3 class="text-xl font-bold mb-4">My Requests</h3>
                <ul id="requests-list" class="flex flex-col gap-4">
                    <!-- Requests will be populated here by JavaScript -->
                    <li class="text-gray-400 text-center">No requests found.</li>
                </ul>
            </div>
        </div>

        <!-- Leaderboard Section -->
        <div id="leaderboard-section" class="page-section pt-8">
            <h2 class="text-3xl font-bold text-center mb-4">Leaderboard</h2>
            <div class="bg-slate-800 p-6 rounded-xl shadow-lg">
                <ul id="leaderboard-list" class="flex flex-col gap-2">
                    <li class="flex justify-between items-center py-2 border-b border-slate-700">
                        <span class="font-bold text-blue-400">1.</span>
                        <span class="flex-1 ml-4 truncate">Player1</span>
                        <span class="font-bold text-green-400">Wins: 15</span>
                    </li>
                    <li class="flex justify-between items-center py-2 border-b border-slate-700">
                        <span class="font-bold text-gray-400">2.</span>
                        <span class="flex-1 ml-4 truncate">Player2</span>
                        <span class="font-bold text-green-400">Wins: 12</span>
                    </li>
                    <li class="flex justify-between items-center py-2">
                        <span class="font-bold text-gray-400">3.</span>
                        <span class="flex-1 ml-4 truncate">Player3</span>
                        <span class="font-bold text-green-400">Wins: 10</span>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Profile Section -->
        <div id="profile-section" class="page-section pt-8">
            <h2 class="text-3xl font-bold text-center mb-4">Profile</h2>
            <div class="p-6 bg-slate-800 rounded-xl shadow-lg flex flex-col items-center">
                <div class="w-24 h-24 bg-gray-600 rounded-full flex items-center justify-center mb-4">
                    <i class="fas fa-user text-5xl text-gray-400"></i>
                </div>
                <h3 id="profile-username" class="text-2xl font-bold mb-1">Username</h3>
                <p id="profile-user-id" class="text-sm text-gray-400 mb-4">User ID:</p>
                <div class="w-full flex justify-between gap-4 text-center">
                    <div class="flex-1 p-4 bg-slate-700 rounded-xl">
                        <p class="text-sm text-gray-400">Total Wins:</p>
                        <p id="profile-wins" class="text-xl font-bold text-green-400">0</p>
                    </div>
                    <div class="flex-1 p-4 bg-slate-700 rounded-xl">
                        <p class="text-sm text-gray-400">Games Played:</p>
                        <p id="profile-games-played" class="text-xl font-bold text-blue-400">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard Section -->
        <div id="admin-section" class="page-section pt-8" >
            <h2 class="text-3xl font-bold text-center mb-4">Admin Dashboard</h2>
            <div class="p-6 bg-slate-800 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold mb-4">Pending Requests</h3>
                <div class="flex justify-between font-bold text-gray-400 mb-2">
                    <span class="w-1/4">Type</span>
                    <span class="w-1/4">User ID</span>
                    <span class="w-1/4">Amount</span>
                    <span class="w-1/4 text-right">Actions</span>
                </div>
                <ul id="admin-requests-list" class="flex flex-col gap-2">
                    <!-- Requests will be populated by JavaScript -->
                    <li class="text-gray-400 text-center py-4">No pending requests.</li>
                </ul>
            </div>
        </div>
    </main>

    <div id="message-container"></div>
    <button id="admin-btn" class="admin-dashboard-btn px-4 py-2 bg-red-500 text-white rounded-lg shadow-lg hidden">
        Admin Dashboard
    </button>

    <!-- Navbar -->
    <nav class="navbar grid grid-cols-4 gap-4">
        <div class="navbar-item active" data-page="game-section">
            <i class="fas fa-dice text-xl mb-1"></i>
            <span class="text-xs">Game</span>
        </div>
        <div class="navbar-item" data-page="wallet-section">
            <i class="fas fa-wallet text-xl mb-1"></i>
            <span class="text-xs">Wallet</span>
        </div>
        <div class="navbar-item" data-page="leaderboard-section">
            <i class="fas fa-trophy text-xl mb-1"></i>
            <span class="text-xs">Leaderboard</span>
        </div>
        <div class="navbar-item" data-page="profile-section">
            <i class="fas fa-user-circle text-xl mb-1"></i>
            <span class="text-xs">Profile</span>
        </div>
    </nav>

    <script>
       
  // --- WebSocket Setup ---
  const ws = new WebSocket("wss://bingo-bot-production.up.railway.app");
  // --- Generate or Retrieve User Phone ---
  function getUserPhone() {
  let phone = localStorage.getItem('bingoPhone');

  // If phone not found or invalid, ask again
  while (!phone || phone === "null" || phone.trim() === "") {
    phone = prompt("Please enter your phone number (e.g. 0912345678):");
    if (phone && phone.trim() !== "") {
      localStorage.setItem('bingoPhone', phone.trim());
      break;
    }
  }

  return phone;
}

  // --- Detect if Admin ---
  const adminPhones = ["0912735222"];
  let myPhone = getUserPhone();
  let IS_ADMIN = adminPhones.includes(myPhone);

  // --- When Connected ---
  ws.addEventListener("open", () => {
    console.log("âœ… Connected to server as", IS_ADMIN ? "Admin" : "Player");
    ws.send(JSON.stringify({
      type: "get_player_data",
      phone: myPhone,
      username: null
    }));
    ws.send(JSON.stringify({ type: "get_room_status" }));
  });

            
        // UI Elements
        const pageSections = document.querySelectorAll('.page-section');
        const navItems = document.querySelectorAll('.navbar-item');
        const roomSelectionContainer = document.getElementById('room-selection-container');
        const cardSelectionContainer = document.getElementById('card-selection-container');
        const cardSelectionGrid = document.getElementById('card-selection-grid');
        const startGameBtn = document.getElementById('start-game-btn');
        const cardsSelectedInfo = document.getElementById('cards-selected-info');
        const gameBoardContainerEl = document.getElementById('game-board-container');
        const cardsContainerEl = document.getElementById('cards-container');
        const jackpotDisplayEls = document.querySelectorAll('.jackpot-display');
        const costDisplayEls = document.querySelectorAll('.cost-display');
        const calledNumberCircleEl = document.getElementById('called-number-circle');
        const bingoBtn = document.getElementById('bingo-btn');
        const gameStatusEl = document.getElementById('game-status');
        const roomInfoEl = document.getElementById('room-info');
        const longBoardEl = document.getElementById('long-board');
        const calledNumbersCountEl = document.getElementById('called-numbers-count');

        const walletBalanceEl = document.getElementById('wallet-balance');
        const profileUsernameEl = document.getElementById('profile-username');
        const profileUserIdEl = document.getElementById('profile-user-id');
        const profileWinsEl = document.getElementById('profile-wins');
        const profileGamesPlayedEl = document.getElementById('profile-games-played');
        const leaderboardListEl = document.getElementById('leaderboard-list');

        const depositTabBtn = document.getElementById('deposit-tab-btn');
        const withdrawTabBtn = document.getElementById('withdraw-tab-btn');
        const requestsTabBtn = document.getElementById('requests-tab-btn');
        const depositFormContainer = document.getElementById('deposit-form-container');
        const withdrawFormContainer = document.getElementById('withdraw-form-container');
        const requestsContainer = document.getElementById('requests-container');
        const requestsList = document.getElementById('requests-list');
        const adminBtn = document.getElementById('admin-btn');
        const adminRequestsList = document.getElementById('admin-requests-list');

        const infoPlayersEl = document.getElementById('info-players');
        const infoAmountEl  = document.getElementById('info-amount');
        const infoJackpotEl  = document.getElementById('info-jackpot');
        const infoCalledEl   = document.getElementById('info-called');
        // Hamburger toggle
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const hamburgerMenu = document.getElementById('hamburger-menu');
        hamburgerBtn.addEventListener("click", () => {
        hamburgerMenu.classList.toggle("hidden");
  });

     
  // Game State
        const BINGO_LETTERS = ['B', 'I', 'N', 'G', 'O'];
        let myCards = [];
        let myPlayerId = '';
        let currentRoomId = '';
        let allGeneratedCards = [];
        let selectedCards = [];  // your current selections
        let takenNumbers = [];   // numbers already taken by others (from server)
        const MAX_SELECTION = 4; // max selectable cards
               
               
        // Generate a simple, consistent user ID
          
        
if (startGameBtn) {
  startGameBtn.addEventListener("click", () => {
    if (selectedCards.length >= 1) {
      // Tell server to start
      ws.send(JSON.stringify({
        type: "start_game",
        roomId: currentRoomId,
        phone: myPhone,
        cards: selectedCards
      }));

      // Disable button to prevent multiple clicks
      startGameBtn.disabled = true;
      startGameBtn.textContent = "Starting...";
    } else {
      alert("Please select at least one card before starting.");
    }
  });
}

 
                    // Function to switch between UI pages
        function showPage(pageId) {
  pageSections.forEach(section => section.classList.remove('active'));
  navItems.forEach(item => item.classList.remove('active'));

  document.getElementById(pageId).classList.add('active');

  // Highlight current menu item
  const navItem = document.querySelector(`#hamburger-menu a[data-page="${pageId}"]`);
  if (navItem) navItem.classList.add('active');

  // Existing WebSocket logic
  if (pageId === 'admin-section') {
    ws.send(JSON.stringify({ type: 'get_admin_requests' }));
  } else if (pageId === 'wallet-section') {
    showWalletTab('deposit');
    ws.send(JSON.stringify({ type: 'get_player_data', userId: myUserId }));
  } else if (pageId === 'leaderboard-section') {
    ws.send(JSON.stringify({ type: 'get_leaderboard' }));
  } else if (pageId === 'profile-section') {
    ws.send(JSON.stringify({ type: 'get_player_data', userId: myUserId }));
  } else if (pageId === 'game-section') {
    ws.send(JSON.stringify({ type: 'get_room_status' }));
  }
}

document.querySelectorAll('#hamburger-menu a').forEach(link => {
  link.addEventListener('click', e => {
    e.preventDefault(); // stop page reload
    const pageId = e.target.getAttribute('data-page');
    showPage(pageId);
    // Close the menu after clicking a link
        hamburgerMenu.classList.add('hidden');
  });
});

   
        function showWalletTab(tabId) {
            const tabs = {
                'deposit': depositFormContainer,
                'withdraw': withdrawFormContainer,
                'requests': requestsContainer
            };
            const tabButtons = {
                'deposit': depositTabBtn,
                'withdraw': withdrawTabBtn,
                'requests': requestsTabBtn
            };

            for (const key in tabs) {
                tabs[key].classList.add('hidden');
                tabButtons[key].classList.remove('active-tab');
                tabButtons[key].classList.add('bg-slate-700');
            }
            tabs[tabId].classList.remove('hidden');
            tabButtons[tabId].classList.add('active-tab', 'bg-blue-600');
            tabButtons[tabId].classList.remove('bg-slate-700');
        }

        // Add event listeners for navigation
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const pageId = item.dataset.page;
                showPage(pageId);
            });
        });

        // Add event listeners for wallet tabs
        depositTabBtn.addEventListener('click', () => showWalletTab('deposit'));
        withdrawTabBtn.addEventListener('click', () => showWalletTab('withdraw'));
        requestsTabBtn.addEventListener('click', () => showWalletTab('requests'));

        // Show admin button
         if (IS_ADMIN) {
  // Show red admin button
  adminBtn.classList.remove('hidden');

  // Clicking Requests tab (admin view)
  requestsTabBtn.addEventListener('click', () => {
    showWalletTab('requests');
    ws.send(JSON.stringify({ type: "get_admin_requests" }));
  });

  // Clicking Admin Dashboard button
  adminBtn.addEventListener('click', () => {
    // Use showPage logic for consistency
    showPage('admin-section');
    // Fetch admin requests
    ws.send(JSON.stringify({ type: "get_admin_requests" }));
  });
} else {
  // Normal users
  requestsTabBtn.addEventListener('click', () => {
    showWalletTab('requests');
    ws.send(JSON.stringify({
      type: "get_user_requests",
      phone: myPhone
    }));
  });
}

        function showMessage(message, type = 'info') {
            const messageEl = document.createElement('div');
            messageEl.textContent = message;
            messageEl.className = `message-box rounded-lg shadow-lg text-white p-4`;

            if (type === 'success') {
                messageEl.classList.add('bg-green-500');
            } else if (type === 'error') {
                messageEl.classList.add('bg-red-500');
            } else {
                messageEl.classList.add('bg-blue-500');
            }

            document.getElementById('message-container').appendChild(messageEl);

            setTimeout(() => {
                messageEl.remove();
            }, 5000);

 }



function showWinnerPopup(winnerId, winningCard, winningPattern) {
    // Remove any existing popup first
    const existing = document.getElementById('winner-popup');
    if (existing) existing.remove();

    // Disable Bingo button while popup is visible
    if (typeof bingoBtn !== 'undefined') bingoBtn.disabled = true;

    // Create overlay
    const overlay = document.createElement('div');
    overlay.id = 'winner-popup';
    overlay.className = 'fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50';

    // Create popup container
    const popup = document.createElement('div');
    popup.className = 'bg-white p-6 rounded-lg text-center w-80';

    // Winner message
    const message = document.createElement('h2');
    message.className = 'text-xl font-bold mb-4';
    message.textContent = winnerId === myPhone ? 'You won! ðŸŽ‰' : 'Someone else won ðŸ˜¢';
    popup.appendChild(message);

    // Show winning card with highlighted pattern
    if (winningCard) {
        const cardEl = createBingoCard(winningCard);
        if (winningPattern) {
            winningPattern.forEach(([row, col]) => {
                const cell = cardEl.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                if (cell) cell.classList.add('bg-yellow-400', 'text-black');
            });
        }
        popup.appendChild(cardEl);
    }

    // Buttons container
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'mt-4 flex justify-around';

    // Play Again button
    const playAgainBtn = document.createElement('button');
    playAgainBtn.textContent = 'Play Again';
    playAgainBtn.className = 'px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600';
    playAgainBtn.addEventListener('click', () => {
        overlay.remove();
        // Re-enable Bingo button
        if (typeof bingoBtn !== 'undefined') bingoBtn.disabled = false;
        // Reset game board and show card selection
        if (cardsContainerEl) cardsContainerEl.innerHTML = '';
        if (cardSelectionContainer) cardSelectionContainer.classList.remove('hidden');
        if (gameBoardContainerEl) gameBoardContainerEl.classList.add('hidden');
        generateCardSelection();
    });

    // Close button
    const closeBtn = document.createElement('button');
    closeBtn.textContent = 'Close';
    closeBtn.className = 'px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600';
    closeBtn.addEventListener('click', () => {
        overlay.remove();
        if (typeof bingoBtn !== 'undefined') bingoBtn.disabled = false;
    });

    buttonsDiv.appendChild(playAgainBtn);
    buttonsDiv.appendChild(closeBtn);
    popup.appendChild(buttonsDiv);

    overlay.appendChild(popup);
    document.body.appendChild(overlay);
}


        function createBingoCard(cardData) {
  // Accept two shapes:
  // Shape 1 (preferred): { B: [...], I: [...], N: [...], G: [...], O: [...] }
  // Shape 2: 5x5 grid array: [ [B0,I0,N0,G0,O0], [B1,I1,...], ... ]
  const cardWrapper = document.createElement('div');
  cardWrapper.className = "bingo-wrapper";

  const cardEl = document.createElement('div');
  cardEl.className = "bingo-grid";

  const colors = ["orange", "red", "yellow", "green", "purple"];
  // headers
  BINGO_LETTERS.forEach((letter, idx) => {
    const header = document.createElement('div');
    header.className = `bingo-header ${colors[idx]}`;
    header.textContent = letter;
    cardEl.appendChild(header);
  });

  // helper to read a cell safely
  function getCell(i, j) {
    // if letter-object
    if (cardData && typeof cardData === 'object' && cardData.B && Array.isArray(cardData.B)) {
      const letter = BINGO_LETTERS[j];
      return cardData[letter] && cardData[letter][i];
    }
    // if 5x5 grid (rows)
    if (Array.isArray(cardData) && Array.isArray(cardData[0])) {
      return cardData[i] ? cardData[i][j] : undefined;
    }
    return undefined;
  }

  for (let i = 0; i < 5; i++) {
    for (let j = 0; j < 5; j++) {
      const number = getCell(i, j);
      const cell = document.createElement('div');
      cell.className = "bingo-cell";
      cell.dataset.row = i;
      cell.dataset.col = j;

      if (number === 0 || number === "FREE" || number === "Free" || number === null || number === undefined) {
        cell.textContent = "FREE";
        cell.classList.add("free-space");
      } else {
        cell.textContent = number;
        cell.dataset.number = number;
      }

      cell.addEventListener("click", () => {
        cell.classList.toggle("marked");
        if (cell.classList.contains("marked")) {
          cell.innerHTML = "âœ”ï¸";
        } else {
          cell.innerHTML = cell.dataset.number || "FREE";
        }
      });

      cardEl.appendChild(cell);
    }
  }

  cardWrapper.appendChild(cardEl);
return cardWrapper;
}
    
           

function updateGameInfoFromStatus(status) {
  // status is the object for the current room (from room_status_update)
  if (!status) return;
  if (infoPlayersEl) infoPlayersEl.textContent = status.players ?? '0';
  if (infoAmountEl)  infoAmountEl.textContent  = (status.cost ?? 0);
  if (infoJackpotEl)  infoJackpotEl.textContent  = (status.jackpot ?? 0);
  // called count may come from `status.calledCount` OR be updated live via number_called events
  if (infoCalledEl)  infoCalledEl.textContent   = `${status.calledCount ?? (status.calledNumbers ? status.calledNumbers.length : 0)}/75`;
}

                       

        function markNumber(number) {
            const cells = document.querySelectorAll(`.bingo-cell[data-number="${number}"]`);
            cells.forEach(cell => {
                cell.classList.add('marked');
            });

            const longBoardNumbers = document.querySelectorAll('.long-board-number');
            longBoardNumbers.forEach(el => {
                if (parseInt(el.textContent) === number) {
                    el.classList.add('marked');
                }
            });
        }

        function renderCalledNumbers(numbers) {
            longBoardEl.innerHTML = '';
            for (let i = 1; i <= 75; i++) {
                const numberEl = document.createElement('div');
                numberEl.className = 'long-board-number';
                numberEl.textContent = i;
                if (numbers.includes(i)) {
                    numberEl.classList.add('marked');
                }
                longBoardEl.appendChild(numberEl);
            }
        }

        // Populate room selection listeners
        // ===== Room Join Logic =====
        
       // Room join button listener â€” do NOT toggle UI immediately
function attachRoomJoinListeners() {  
  document.querySelectorAll('.room-card button').forEach(button => {                                button.removeEventListener && button.removeEventListener('click', () => {}); // safe remove  
    button.addEventListener('click', (e) => {  
      e.stopPropagation();  
      const card = button.closest('.room-card');      if (!card) return;  
      const roomId = card.dataset.room;               currentRoomId = roomId;                         ws.send(JSON.stringify({ type: 'join_room', roomId, phone: myPhone }));                       if (roomSelectionContainer) roomSelectionContainer.classList.add('hidden');  
      // Just ask to join â€” wait for server to confirm
if (roomSelectionContainer) roomSelectionContainer.classList.add('hidden');

// The server will send "show_cards" when ready  
    });                                           });                                           }  

function initializeApp() {
  attachRoomJoinListeners();
  attachNavbarListeners();
  attachWalletTabListeners();
  attachBingoButtonListener();
  attachDepositFormListener();
  attachWithdrawFormListener();
  attachAdminButtonsListener();
  // Add other initialization code here
}

// Run initialization once DOM is fully loaded
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", initializeApp);
} else {
  initializeApp();
}

       
        // Event listener for Bingo button
        bingoBtn.addEventListener('click', () => {
            if (!currentRoomId) return;
            ws.send(JSON.stringify({ type: 'claim_bingo', phone: myPhone, roomId: currentRoomId }));
        });

        // Handle deposit form submission
        document.getElementById('deposit-form').addEventListener('submit', (e) => {
  e.preventDefault();
  const amount = parseInt(document.getElementById('deposit-amount').value);
  const telebirrMessage = document.getElementById('telebirr-message').value.trim();

  if (isNaN(amount) || amount <= 0) {
    showMessage('Please enter a valid amount.', 'error');
    return;
  }

  ws.send(JSON.stringify({ 
    type: 'request_deposit', 
    amount, 
    phone: myPhone, 
    telebirrMessage  // send this extra info
  }));

  e.target.reset();
});

        // Handle withdrawal form submission
        document.getElementById('withdraw-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const amount = parseInt(document.getElementById('withdraw-amount').value);
            if (isNaN(amount) || amount <= 0) {
                showMessage('Please enter a valid amount.', 'error');
                return;
            }
            ws.send(JSON.stringify({ type: 'request_withdrawal', amount, phone:myPhone }));
            document.getElementById('withdraw-form').reset();
        });

        function renderRequests(requests) {
            requestsList.innerHTML = '';
            if (requests.length === 0) {
                requestsList.innerHTML = '<li class="text-gray-400 text-center">No requests found.</li>';
                return;
            }
            requests.forEach(req => {
                const li = document.createElement('li');
                let statusColor = 'text-yellow-400';
                if (req.status === 'approved') {
                    statusColor = 'text-green-400';
                } else if (req.status === 'rejected') {
                    statusColor = 'text-red-400';
                }
                li.className = 'flex justify-between items-center p-2 bg-slate-700 rounded-lg';
                li.innerHTML = `
                    <span class="text-sm font-semibold">${req.type.toUpperCase()}</span>
                    <span class="text-sm">${req.amount}</span>
                    <span class="font-bold ${statusColor}">${req.status.toUpperCase()}</span>
                `;
                requestsList.appendChild(li);
            });
        }


function generateCardSelection() {
  if (!currentRoomId) return;
  // Ask server for the room's 1..100 cards (id + takenBy)
  ws.send(JSON.stringify({
    type: 'get_cards',
    roomId: currentRoomId
  }));
}  
function renderRoomCards(cards) {
  // Expect cards: [{ id, takenBy }, ...]
  cardSelectionGrid.innerHTML = '';

  // Make sure it's an array
  if (!Array.isArray(cards)) cards = [];

  // Reset selectedCards and re-populate from server authoritative state
  selectedCards = [];

  cards.forEach(card => {
    const cardId = Number(card.id);
    const cardEl = document.createElement('div');
    cardEl.className = 'card-selection-item';
    cardEl.textContent = cardId;
    cardEl.dataset.cardId = String(cardId);

    if (card.takenBy) {
      cardEl.classList.add('taken-card');
      if (card.takenBy === myPhone) {
        cardEl.classList.add('selected');
        if (!selectedCards.includes(cardId)) selectedCards.push(cardId);
      }
    }

    cardEl.addEventListener('click', () => {
      // already taken?
      if (cardEl.classList.contains('taken-card')) {
        alert("This card is already taken!");
        return;
      }

      // deselect local
      if (selectedCards.includes(cardId)) {
        selectedCards = selectedCards.filter(id => id !== cardId);
        cardEl.classList.remove('selected');
        updateSelectedInfo();
        // optional server release call if your server supports it (not required)
        return;
      }

      // enforce max
      if (selectedCards.length >= MAX_SELECTION) {
        alert(`You can select up to ${MAX_SELECTION} cards.`);
        return;
      }

      // request selection â€” wait for server confirmation
      ws.send(JSON.stringify({
        type: 'select_card',
        roomId: currentRoomId,
        cardId: cardId,
        phone: myPhone
      }));
    });

    cardSelectionGrid.appendChild(cardEl);
  });

  updateSelectedInfo();
}
    
     
// ----- Update selected info and start button -----
function updateSelectedInfo() {
    cardsSelectedInfo.textContent = `${selectedCards.length}/4 cards selected`;
    // change to desired minimum required to enable start:
    startGameBtn.disabled = selectedCards.length < 1;
}

        
        function renderAdminRequests(requests) {
  adminRequestsList.innerHTML = '';

  if (!requests || requests.length === 0) {
    adminRequestsList.innerHTML = '<li class="text-gray-400 text-center py-4">No pending requests.</li>';
    return;
  }

  requests.forEach(req => {
    const li = document.createElement('li');
    li.className = 'flex justify-between items-center py-2 border-b border-slate-700 last:border-b-0';

    li.innerHTML = `
      <div class="w-1/4 text-sm font-bold truncate">${req.type.toUpperCase()}</div>
      <div class="w-1/4 text-sm truncate" title="${req.phone || 'Unknown'}">${req.phone || 'Unknown'}</div>
      <div class="w-1/4 text-sm font-bold text-yellow-400">${req.amount}</div>
      <div class="w-1/4 flex gap-2 justify-end">
        <button class="approve-btn bg-green-500 hover:bg-green-600 text-white rounded-lg p-2 text-xs" data-request-id="${req.id}">Approve</button>
        <button class="reject-btn bg-red-500 hover:bg-red-600 text-white rounded-lg p-2 text-xs" data-request-id="${req.id}">Reject</button>
      </div>
    `;

    adminRequestsList.appendChild(li);
  });

  // âœ… Add event listeners
  document.querySelectorAll('.approve-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const requestId = e.target.dataset.requestId;
      ws.send(JSON.stringify({ type: 'approve_request', requestId }));
    });
  });

  document.querySelectorAll('.reject-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const requestId = e.target.dataset.requestId;
      ws.send(JSON.stringify({ type: 'reject_request', requestId }));
    });
  });
}
             


// âœ… Listen for messages
ws.onmessage = event => {
  const data = JSON.parse(event.data);

  switch (data.type) {

        // ------------------ PLAYER DATA ---------------
    case "player_data":
      walletBalanceEl.textContent = data.balance;

      // âœ… Show username and phone number properly
      profileUsernameEl.textContent = data.username || `Player_${data.phone}`;
      profileUserIdEl.textContent = `Phone: ${data.phone}`;

      profileWinsEl.textContent = data.wins;
      profileGamesPlayedEl.textContent = data.gamesPlayed;

      // âœ… Show admin dashboard only for actual admins
      if (data.isAdmin) {
        document.getElementById('admin-btn').classList.remove('hidden');
      } else {
        document.getElementById('admin-btn').classList.add('hidden');
      }

      renderRequests(data.requests || []);
      break;
       
    case "balance_update":
      walletBalanceEl.textContent = data.balance;
      break;

    // ------------------ ROOM STATUS ------------------
    case "room_status_update": {
  for (const roomId in data.room_status) {
    const status = data.room_status[roomId];

    // Update the room cards (existing behavior)
    const playerEl = document.querySelector(`.room-card[data-room="${roomId}"] p:nth-child(2)`);
    const jackpotEl = document.querySelector(`.jackpot-display[data-room="${roomId}"]`);
    const costEl = document.querySelector(`.cost-display[data-room="${roomId}"]`);

    if (playerEl) playerEl.textContent = `${status.players} Players`;
    if (jackpotEl) jackpotEl.textContent = `${status.jackpot} coins`;
    if (costEl) costEl.textContent = status.cost;

    // âœ… Update main info bar ONLY for the current room
    if (roomId === currentRoomId) {
      if (infoPlayersEl) infoPlayersEl.textContent = `${status.players} `;
      if (infoAmountEl) infoAmountEl.textContent = `${status.cost} `;
      if (infoJackpotEl) infoJackpotEl.textContent = `${status.jackpot} `;
      if (infoCalledEl) infoCalledEl.textContent = status.calledNumbers
        ? `${status.calledNumbers.length}/75`
        : `0/75`;
    }
  }
  break;
}
    
case "requests_data":
  if (IS_ADMIN) {
    renderAdminRequests(data.requests);
  } else {
    renderRequests(data.requests);
  }
  break;

    // ------------------ ROOM JOIN ------------------
    case "room_joined":
  myPhone = data.phone;
  currentRoomId = data.roomId;
  walletBalanceEl.textContent = data.balance;

  // Now show card selection
  cardSelectionContainer.classList.remove("hidden");
  gameBoardContainerEl.classList.add("hidden");
  gameStatusEl.textContent = "Select up to 4 cards...";

  // âœ… Now safely ask server for available cards
  ws.send(JSON.stringify({
    type: "get_cards",
    roomId: currentRoomId
  }));
  break;
    // ------------------ SHOW CARDS ------------------
    case "room_cards":
  // Selection-phase: server sends [{id, takenBy}, ...]
  if (data.roomId === currentRoomId) {
    renderRoomCards(data.cards);
  }
  break;

  case "show_cards":
  if (data.phase === "game") {
    // Hide selection UI
    roomSelectionContainer.classList.add("hidden");
    cardSelectionContainer.classList.add("hidden");
    gameBoardContainerEl.classList.remove("hidden");

    // Render the player's selected cards immediately
    myCards = data.cards;
    cardsContainerEl.innerHTML = "";
    myCards.forEach(card => cardsContainerEl.appendChild(createBingoCard(card)));

    // âœ… Fix label (remove "Select up to 4 cards...")
    gameStatusEl.textContent = "Game starting soon...";
  }
  break;
           
    // ------------------ CARD SELECTION ------------------
    case 'card_selected': {
  if (data.roomId === currentRoomId) {
    const cardId = Number(data.cardId);
    if (!selectedCards.includes(cardId)) selectedCards.push(cardId);
    const cardEl = document.querySelector(`[data-card-id="${cardId}"]`);
    if (cardEl) cardEl.classList.add('selected');
    updateSelectedInfo();
  }
  break;
}

case 'card_taken': {
  if (data.roomId === currentRoomId) {
    const cardId = Number(data.cardId);
    const owner = data.phone;
    const cardEl = document.querySelector(`[data-card-id="${cardId}"]`);
    if (cardEl) {
      cardEl.classList.add('taken-card');
      if (owner === myPhone) {
        cardEl.classList.add('selected');
        if (!selectedCards.includes(cardId)) selectedCards.push(cardId);
      } else {
        // someone else took it: remove from our selectedCards if present
        if (selectedCards.includes(cardId)) {
          selectedCards = selectedCards.filter(id => id !== cardId);
          cardEl.classList.remove('selected');
        }
      }
    }
    updateSelectedInfo();
  }
  break;
}
        
    case "card_rejected":
      alert("Card selection failed: " + (data.reason || "unknown"));
      break;

    // ------------------ GAME NUMBERS ------------------
    case "number_called":
  if (data.countdown) {
    // Countdown before game starts (server sync)
    if (calledNumberCircleEl) calledNumberCircleEl.textContent = data.number;
    gameStatusEl.textContent = `Game starting in ${data.number}s...`;
  } else {
    // Actual number during the game
    
    markNumber(data.number);
    if (calledNumberCircleEl) calledNumberCircleEl.textContent = data.number;
    if (calledNumbersCountEl) calledNumbersCountEl.textContent = data.calledNumbers.length;
    if (infoCalledEl) infoCalledEl.textContent = `${data.calledNumbers.length}/75`;
    gameStatusEl.textContent = "Game in progress!";

    renderCalledNumbers(data.calledNumbers);
  }

  break;

    
   case "room_countdown": {
  // Update countdown on the room selection front page
  const countdownEl = document.querySelector(`.countdown[data-room="${data.roomId}"]`);
  if (countdownEl) {
    countdownEl.textContent = data.timeLeft > 0 ? `${data.timeLeft}s` : "--";
  }
  break;
}

case "countdown": {
  // Update called number circle if player is inside the active game
  if (data.roomId === currentRoomId) {
    if (calledNumberCircleEl) calledNumberCircleEl.textContent = data.timeLeft;
    if (gameStatusEl) gameStatusEl.textContent = `Game starting...`;
  }
  break;
}
   case "withdraw_response":
  alert(data.message);
  if (data.success) {
    walletBalanceEl.textContent = data.balance;
  }
  break;
   case "deposit_response":
  alert(data.message);
  if (data.success) {
    walletBalanceEl.textContent = data.newBalance;
  }
  break;
    case "game_started": {
  // Server may send two shapes:
  // Shape A: { cards: [ { phone, cards: [...] }, ... ], numbersCalled: [] }
  // Shape B: { cards: [ {...formatted card...}, {...} ], numbersCalled: [] }  (only for this player)

  // If shape A (array of players), find this user's cards
  let playerEntry = null;
  if (Array.isArray(data.cards) && data.cards.length > 0 && data.cards[0].phone) {
    playerEntry = data.cards.find(p => p.phone === myPhone);
    if (!playerEntry) {
      console.warn('game_started: server sent card list but no entry for this user', data.cards);
      // fallback: maybe server sends player's cards via show_cards separately â€” wait.
      return;
    }
    myCards = playerEntry.cards || [];
  } else if (Array.isArray(data.cards)) {
    // shape B: server directly sent formatted cards for this player
    myCards = data.cards;
  } else {
    console.warn('game_started: unexpected cards payload', data);
    myCards = [];
  }

  // render
  renderCalledNumbers([]); // start with empty called numbers
  cardsContainerEl.innerHTML = '';
  myCards.forEach(card => cardsContainerEl.appendChild(createBingoCard(card)));

  cardSelectionContainer.classList.add('hidden');
  gameBoardContainerEl.classList.remove('hidden');
  gameStatusEl.textContent = 'Game in progress!';
  if (calledNumberCircleEl) calledNumberCircleEl.textContent = '';
  break;
}
    // ------------------ BINGO ------------------
    case "bingo_win": {
  const winner = data.winnerPhone; // server sends this
  const iWon = winner === myPhone;

  gameStatusEl.textContent = iWon
    ? "ðŸŽ‰ BINGO! You won!"
    : "ðŸ˜¢ BINGO! Someone else won.";

  showMessage(
    iWon ? "BINGO! You won the game!" : "Someone else called BINGO first.",
    iWon ? "success" : "error"
  );

  showWinnerPopup(winner, data.winningCard, data.winningPattern);
  bingoBtn.disabled = true;
 
 break;
}
    case "bingo_lose":
      gameStatusEl.textContent = "BINGO! Someone else won.";
      showMessage("Someone else called BINGO first. Better luck next time.", "error");
      bingoBtn.disabled = true;
      break;
l
    case "invalid_bingo":
      gameStatusEl.textContent = "Game in progress.";
      showMessage("Sorry, that is not a valid BINGO.", "error");
      break;

    case "game_end":
      gameStatusEl.textContent = "Game Over!";
      break;

    // ------------------ ERRORS ------------------
    case "error":
      showMessage(data.message, "error");
      break;
  }
};

// ------------------ INITIAL REQUESTS ------------------
showPage("game-section");
ws.addEventListener("open", () => {
  ws.send(JSON.stringify({ type: "get_player_data", phone: myPhone }));
  ws.send(JSON.stringify({ type: "get_room_status" }));
});
             
    </script>
</body>
</html>
