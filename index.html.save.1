<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bingo Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A;
            color: #E2E8F0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .page-section {
            display: none;
            padding-bottom: 7rem; /* Space for the navbar */
        }
        .page-section.active {
            display: block;
        }
        .navbar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #1E293B;
            border-top: 1px solid #334155;
            z-index: 1000;
        }
        .navbar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 0;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            color: #94A3B8;
        }
        .navbar-item.active {
            color: #38BDF8;
            background-color: #121A26;
        }
        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.25rem;
            width: 100%;
            max-width: 300px;
            margin: auto;
        }
        .bingo-header {
            text-align: center;
            font-weight: bold;
            font-size: 1.5rem;
            color: #38BDF8;
            padding: 0.5rem;
        }
        .bingo-cell {
            background-color: #1E293B;
            border-radius: 0.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.25rem;
            height: 50px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .bingo-cell.marked {
            background-color: #6EE7B7;
            color: #1E293B;
        }
        .bingo-cell.free-space {
            font-weight: bold;
            background-color: #64748B;
        }
        .card-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 1rem;
            max-height: 50vh;
            overflow-y: auto;
        }
        .card-selection-item {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 60px;
            height: 60px;
            background-color: #1E293B;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .card-selection-item.selected {
            background-color: #38BDF8;
            color: #0F172A;
        }
        .long-board-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.5rem;
            padding: 1rem;
            background-color: #1E293B;
            border-radius: 0.75rem;
        }
        .long-board-number {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 40px;
            width: 40px;
            border-radius: 50%;
            background-color: #334155;
        }
        .long-board-number.marked {
            background-color: #6EE7B7;
            color: #1E293B;
            font-weight: bold;
        }
        .called-number-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #38BDF8;
            color: #0F172A;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
            font-weight: bold;
        }
        .message-box {
            position: fixed;
            bottom: 6rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            color: white;
            z-index: 2000;
            transition: opacity 0.5s ease-in-out;
            opacity: 0;
            animation: fadeInOut 5s forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }
        .admin-dashboard-btn {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1001;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 flex flex-col items-center">

    <main class="container mx-auto p-4 flex-grow w-full max-w-lg">
        <!-- Game Section -->
        <div id="game-section" class="page-section active pt-8">
            <h1 class="text-4xl font-bold text-center mb-8">
                <span class="text-blue-400">TOP</span> BINGO
            </h1>

            <!-- Room Selection -->
            <div id="room-selection-container">
                <h2 class="text-2xl font-bold mb-4">Join a Game Room</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="room-card p-6 bg-slate-800 rounded-xl shadow-lg transition-transform transform hover:scale-105 cursor-pointer text-center" data-room="room_10">
                        <i class="fas fa-users text-4xl mb-2 text-blue-400"></i>
                        <h3 class="font-bold text-lg">á‰£áˆˆ 10 á‰¥áˆ­ </h3>
                        <p class="text-sm text-gray-400">0 á‰°áŒ«á‹‹á‰½</p>
                        <p class="text-sm font-bold mt-2 text-green-400">Jackpot: <span class="jackpot-display" data-room="room_1">0</span></p>
                        <p class="text-sm text-yellow-400">Entry: <span class="cost-display" data-room="room_1">0</span> coins</p>
                    </div>
                    <div class="room-card p-6 bg-slate-800 rounded-xl shadow-lg transition-transform transform hover:scale-105 cursor-pointer text-center" data-room="room_20">
                        <i class="fas fa-users text-4xl mb-2 text-blue-400"></i>
                        <h3 class="font-bold text-lg">á‰£áˆˆ 20 á‰¥áˆ­ </h3>
                        <p class="text-sm text-gray-400">0 á‰°áŒ«á‹‹á‰½</p>
                        <p class="text-sm font-bold mt-2 text-green-400">Jackpot: <span class="jackpot-display" data-room="room_2">0</span></p>
                        <p class="text-sm text-yellow-400">Entry: <span class="cost-display" data-room="room_2">0</span> coins</p>
                    </div>
                    <div class="room-card p-6 bg-slate-800 rounded-xl shadow-lg transition-transform transform hover:scale-105 cursor-pointer text-center" data-room="room_3">
                        <i class="fas fa-users text-4xl mb-2 text-blue-400"></i>
                        <h3 class="font-bold text-lg">á‰£áˆˆ 50 á‰¥áˆ­ </h3>
                        <p class="text-sm text-gray-400">0 á‰°áŒ«á‹‹á‰½</p>
                        <p class="text-sm font-bold mt-2 text-green-400">Jackpot: <span class="jackpot-display" data-room="room_3">0</span></p>
                        <p class="text-sm text-yellow-400">Entry: <span class="cost-display" data-room="room_3">0</span> coins</p>
                    </div>
                    <div class="room-card p-6 bg-slate-800 rounded-xl shadow-lg transition-transform transform hover:scale-105 cursor-pointer text-center" data-room="room_4">
                        <i class="fas fa-users text-4xl mb-2 text-blue-400"></i>
                        <h3 class="font-bold text-lg">á‰£áˆˆ 100 á‰¥áˆ­ </h3>
                        <p class="text-sm text-gray-400">0 á‰°áŒ«á‹‹á‰½</p>
                        <p class="text-sm font-bold mt-2 text-green-400">Jackpot: <span class="jackpot-display" data-room="room_4">0</span></p>
                        <p class="text-sm text-yellow-400">Entry: <span class="cost-display" data-room="room_4">0</span> coins</p>
                    </div>
                </div>
            </div>

            <!-- Card Selection -->
            <div id="card-selection-container" class="hidden">
                <h2 class="text-2xl font-bold mb-4">Select Your Cards</h2>
                <p class="text-gray-400 mb-4">Choose between 1 and 4 cards to play. Jackpot increases with more cards!</p>
                <div id="card-selection-grid" class="card-selection-grid p-4 bg-slate-800 rounded-xl shadow-inner"></div>
                <div class="mt-4 flex flex-col items-center gap-2">
                    <p id="cards-selected-info" class="text-lg font-bold text-center">0/4 cards selected</p>
                    <button id="start-game-btn" class="w-full px-6 py-3 mt-4 text-lg font-bold text-white bg-blue-500 rounded-xl shadow-lg transition-colors hover:bg-blue-600 disabled:bg-gray-500" disabled>
                        Start Game
                    </button>
                </div>
            </div>

            <!-- Game Board -->
            <div id="game-board-container" class="hidden">
                <div class="flex flex-col items-center">
                    <p id="game-status" class="text-xl font-bold mb-2 text-center text-blue-400">Waiting for players...</p>
                    <div class="flex items-center justify-center gap-4 mb-6">
                        <p class="text-gray-400 text-sm">Called Numbers: <span id="called-numbers-count" class="font-bold text-white">0</span>/75</p>
                    </div>
                    <div class="flex flex-col items-center mb-6">
                        <div id="called-number-circle" class="called-number-circle">00</div>
                        <p class="text-sm text-gray-400 mt-2">Latest Number</p>
                    </div>

                    <div id="cards-container" class="flex flex-col gap-4 w-full"></div>
                    
                    <button id="bingo-btn" class="w-full px-6 py-3 mt-6 text-lg font-bold text-white bg-green-500 rounded-xl shadow-lg transition-colors hover:bg-green-600">
                        <i class="fas fa-star mr-2"></i> BINGO!
                    </button>
                </div>

                <div class="mt-8">
                    <h3 class="text-xl font-bold mb-4 text-center">Called Numbers</h3>
                    <div id="long-board" class="long-board-container"></div>
                </div>
            </div>
        </div>

        <!-- Wallet Section -->
        <div id="wallet-section" class="page-section pt-8">
            <h2 class="text-3xl font-bold text-center mb-4">Wallet</h2>
            <div class="flex items-center justify-between p-4 bg-slate-800 rounded-xl shadow-lg mb-6">
                <span class="text-lg text-gray-400">Your Balance:</span>
                <span id="wallet-balance" class="text-3xl font-bold text-green-400">0.00</span>
            </div>

            <div class="w-full max-w-sm mx-auto flex">
                <button id="deposit-tab-btn" class="flex-1 p-3 text-center rounded-tl-xl rounded-bl-xl transition-colors bg-slate-700 active-tab">
                    Deposit
                </button>
                <button id="withdraw-tab-btn" class="flex-1 p-3 text-center transition-colors bg-slate-700">
                    Withdraw
                </button>
                <button id="requests-tab-btn" class="flex-1 p-3 text-center rounded-tr-xl rounded-br-xl transition-colors bg-slate-700">
                    My Requests
                </button>
            </div>
            
            <div id="deposit-form-container" class="mt-4 p-6 bg-slate-800 rounded-xl shadow-lg active-tab-content">
                <h3 class="text-xl font-bold mb-2">Request Deposit</h3>
                <p class="text-sm text-gray-400 mb-4">Enter the amount you wish to deposit. An admin will approve it shortly.</p>
                <form id="deposit-form" class="flex flex-col gap-4">
                    <div>
                        <label for="deposit-amount" class="text-sm text-gray-400">Amount</label>
                        <input type="number" id="deposit-amount" class="w-full mt-1 p-3 bg-slate-700 rounded-lg outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="e.g. 50" min="1" required>
                    </div>
                    <button type="submit" class="w-full px-6 py-3 text-lg font-bold text-white bg-blue-500 rounded-xl shadow-lg transition-colors hover:bg-blue-600">
                        Request Deposit
                    </button>
                </form>
            </div>
            
            <div id="withdraw-form-container" class="mt-4 p-6 bg-slate-800 rounded-xl shadow-lg hidden">
                <h3 class="text-xl font-bold mb-2">Request Withdrawal</h3>
                <p class="text-sm text-gray-400 mb-4">Enter the amount you wish to withdraw.</p>
                <form id="withdraw-form" class="flex flex-col gap-4">
                    <div>
                        <label for="withdraw-amount" class="text-sm text-gray-400">Amount</label>
                        <input type="number" id="withdraw-amount" class="w-full mt-1 p-3 bg-slate-700 rounded-lg outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="e.g. 20" min="1" required>
                    </div>
                    <button type="submit" class="w-full px-6 py-3 text-lg font-bold text-white bg-yellow-500 rounded-xl shadow-lg transition-colors hover:bg-yellow-600">
                        Request Withdrawal
                    </button>
                </form>
            </div>
            
            <div id="requests-container" class="mt-4 p-6 bg-slate-800 rounded-xl shadow-lg hidden">
                <h3 class="text-xl font-bold mb-4">My Requests</h3>
                <ul id="requests-list" class="flex flex-col gap-4">
                    <!-- Requests will be populated here by JavaScript -->
                    <li class="text-gray-400 text-center">No requests found.</li>
                </ul>
            </div>
        </div>

        <!-- Leaderboard Section -->
        <div id="leaderboard-section" class="page-section pt-8">
            <h2 class="text-3xl font-bold text-center mb-4">Leaderboard</h2>
            <div class="bg-slate-800 p-6 rounded-xl shadow-lg">
                <ul id="leaderboard-list" class="flex flex-col gap-2">
                    <li class="flex justify-between items-center py-2 border-b border-slate-700">
                        <span class="font-bold text-blue-400">1.</span>
                        <span class="flex-1 ml-4 truncate">Player1</span>
                        <span class="font-bold text-green-400">Wins: 15</span>
                    </li>
                    <li class="flex justify-between items-center py-2 border-b border-slate-700">
                        <span class="font-bold text-gray-400">2.</span>
                        <span class="flex-1 ml-4 truncate">Player2</span>
                        <span class="font-bold text-green-400">Wins: 12</span>
                    </li>
                    <li class="flex justify-between items-center py-2">
                        <span class="font-bold text-gray-400">3.</span>
                        <span class="flex-1 ml-4 truncate">Player3</span>
                        <span class="font-bold text-green-400">Wins: 10</span>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Profile Section -->
        <div id="profile-section" class="page-section pt-8">
            <h2 class="text-3xl font-bold text-center mb-4">Profile</h2>
            <div class="p-6 bg-slate-800 rounded-xl shadow-lg flex flex-col items-center">
                <div class="w-24 h-24 bg-gray-600 rounded-full flex items-center justify-center mb-4">
                    <i class="fas fa-user text-5xl text-gray-400"></i>
                </div>
                <h3 id="profile-username" class="text-2xl font-bold mb-1">Username</h3>
                <p id="profile-user-id" class="text-sm text-gray-400 mb-4">User ID:</p>
                <div class="w-full flex justify-between gap-4 text-center">
                    <div class="flex-1 p-4 bg-slate-700 rounded-xl">
                        <p class="text-sm text-gray-400">Total Wins:</p>
                        <p id="profile-wins" class="text-xl font-bold text-green-400">0</p>
                    </div>
                    <div class="flex-1 p-4 bg-slate-700 rounded-xl">
                        <p class="text-sm text-gray-400">Games Played:</p>
                        <p id="profile-games-played" class="text-xl font-bold text-blue-400">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard Section -->
        <div id="admin-section" class="page-section pt-8">
            <h2 class="text-3xl font-bold text-center mb-4">Admin Dashboard</h2>
            <div class="p-6 bg-slate-800 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold mb-4">Pending Requests</h3>
                <div class="flex justify-between font-bold text-gray-400 mb-2">
                    <span class="w-1/4">Type</span>
                    <span class="w-1/4">User ID</span>
                    <span class="w-1/4">Amount</span>
                    <span class="w-1/4 text-right">Actions</span>
                </div>
                <ul id="admin-requests-list" class="flex flex-col gap-2">
                    <!-- Requests will be populated by JavaScript -->
                    <li class="text-gray-400 text-center py-4">No pending requests.</li>
                </ul>
            </div>
        </div>
    </main>

    <div id="message-container"></div>
    <button id="admin-btn" class="admin-dashboard-btn px-4 py-2 bg-red-500 text-white rounded-lg shadow-lg hidden">
        Admin Dashboard
    </button>

    <!-- Navbar -->
    <nav class="navbar grid grid-cols-4 gap-4">
        <div class="navbar-item active" data-page="game-section">
            <i class="fas fa-dice text-xl mb-1"></i>
            <span class="text-xs">Game</span>
        </div>
        <div class="navbar-item" data-page="wallet-section">
            <i class="fas fa-wallet text-xl mb-1"></i>
            <span class="text-xs">Wallet</span>
        </div>
        <div class="navbar-item" data-page="leaderboard-section">
            <i class="fas fa-trophy text-xl mb-1"></i>
            <span class="text-xs">Leaderboard</span>
        </div>
        <div class="navbar-item" data-page="profile-section">
            <i class="fas fa-user-circle text-xl mb-1"></i>
            <span class="text-xs">Profile</span>
        </div>
    </nav>
    
    <script>
        // WebSocket URL now uses the current host
        const wsProtocol = (window.location.protocol === 'https:') ? 'wss:' : 'ws:';
const ws = new WebSocket(`${wsProtocol}//${window.location.host}`);
        const IS_ADMIN = true; // Set this to true to see the admin button

        // UI Elements
        const pageSections = document.querySelectorAll('.page-section');
        const navItems = document.querySelectorAll('.navbar-item');
        const roomSelectionContainer = document.getElementById('room-selection-container');
        const cardSelectionContainer = document.getElementById('card-selection-container');
        const cardSelectionGrid = document.getElementById('card-selection-grid');
        const startGameBtn = document.getElementById('start-game-btn');
        const cardsSelectedInfo = document.getElementById('cards-selected-info');
        const gameBoardContainerEl = document.getElementById('game-board-container');
        const cardsContainerEl = document.getElementById('cards-container');
        const jackpotDisplayEls = document.querySelectorAll('.jackpot-display');
        const costDisplayEls = document.querySelectorAll('.cost-display');
        const calledNumberCircleEl = document.getElementById('called-number-circle');
        const bingoBtn = document.getElementById('bingo-btn');
        const gameStatusEl = document.getElementById('game-status');
        const roomInfoEl = document.getElementById('room-info');
        const longBoardEl = document.getElementById('long-board');
        const calledNumbersCountEl = document.getElementById('called-numbers-count');
        
        const walletBalanceEl = document.getElementById('wallet-balance');
        const profileUsernameEl = document.getElementById('profile-username');
        const profileUserIdEl = document.getElementById('profile-user-id');
        const profileWinsEl = document.getElementById('profile-wins');
        const profileGamesPlayedEl = document.getElementById('profile-games-played');
        const leaderboardListEl = document.getElementById('leaderboard-list');

        const depositTabBtn = document.getElementById('deposit-tab-btn');
        const withdrawTabBtn = document.getElementById('withdraw-tab-btn');
        const requestsTabBtn = document.getElementById('requests-tab-btn');
        const depositFormContainer = document.getElementById('deposit-form-container');
        const withdrawFormContainer = document.getElementById('withdraw-form-container');
        const requestsContainer = document.getElementById('requests-container');
        const requestsList = document.getElementById('requests-list');
        const adminBtn = document.getElementById('admin-btn');
        const adminRequestsList = document.getElementById('admin-requests-list');
        
        // Game State
        const BINGO_LETTERS = ['B', 'I', 'N', 'G', 'O'];
        let myCards = [];
        let myPlayerId = '';
        let currentRoomId = '';
        let allGeneratedCards = [];
        let selectedCards = [];
        let myUserId = '';

        // Generate a simple, consistent user ID
        function getUserId() {
            let userId = localStorage.getItem('bingoUserId');
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('bingoUserId', userId);
            }
            return userId;
        }
        myUserId = "u1";
        myUserId = "u2";
        myUserId = "u3";

        // Function to switch between UI pages
        function showPage(pageId) {
            pageSections.forEach(section => {
                section.classList.remove('active');
            });
            navItems.forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById(pageId).classList.add('active');
            const navItem = document.querySelector(`[data-page="${pageId}"]`);
            if (navItem) {
                navItem.classList.add('active');
            }

            if (pageId === 'admin-section') {
                ws.send(JSON.stringify({ type: 'get_admin_requests' }));
            } else if (pageId === 'wallet-section') {
                 showWalletTab('deposit');
                 ws.send(JSON.stringify({ type: 'get_player_data', userId: myUserId }));
            } else if (pageId === 'leaderboard-section') {
                 ws.send(JSON.stringify({ type: 'get_leaderboard' }));
            } else if (pageId === 'profile-section') {
                ws.send(JSON.stringify({ type: 'get_player_data', userId: myUserId }));
            } else if (pageId === 'game-section') {
                ws.send(JSON.stringify({ type: 'get_room_status' }));
            }
        }

        function showWalletTab(tabId) {
            const tabs = {
                'deposit': depositFormContainer,
                'withdraw': withdrawFormContainer,
                'requests': requestsContainer
            };
            const tabButtons = {
                'deposit': depositTabBtn,
                'withdraw': withdrawTabBtn,
                'requests': requestsTabBtn
            };

            for (const key in tabs) {
                tabs[key].classList.add('hidden');
                tabButtons[key].classList.remove('active-tab');
                tabButtons[key].classList.add('bg-slate-700');
            }
            tabs[tabId].classList.remove('hidden');
            tabButtons[tabId].classList.add('active-tab', 'bg-blue-600');
            tabButtons[tabId].classList.remove('bg-slate-700');
        }

        // Add event listeners for navigation
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const pageId = item.dataset.page;
                showPage(pageId);
            });
        });

        // Add event listeners for wallet tabs
        depositTabBtn.addEventListener('click', () => showWalletTab('deposit'));
        withdrawTabBtn.addEventListener('click', () => showWalletTab('withdraw'));
        requestsTabBtn.addEventListener('click', () => showWalletTab('requests'));
        
        // Show admin button if user is an admin
        if (IS_ADMIN) {
            adminBtn.classList.remove('hidden');
            adminBtn.addEventListener('click', () => showPage('admin-section'));
        }


        function showMessage(message, type = 'info') {
            const messageEl = document.createElement('div');
            messageEl.textContent = message;
            messageEl.className = `message-box rounded-lg shadow-lg text-white p-4`;
            
            if (type === 'success') {
                messageEl.classList.add('bg-green-500');
            } else if (type === 'error') {
                messageEl.classList.add('bg-red-500');
            } else {
                messageEl.classList.add('bg-blue-500');
            }
            
            document.getElementById('message-container').appendChild(messageEl);

            setTimeout(() => {
                messageEl.remove();
            }, 5000);

 }


       
function showWinnerPopup(winnerId, winnerCard, winningPattern) {
    // Create overlay
    const overlay = document.createElement('div');
    overlay.id = 'winner-popup';
    overlay.className = 'fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50';

    // Create popup container
    const popup = document.createElement('div');
    popup.className = 'bg-white p-6 rounded-lg text-center w-80';

    // Winner message
    const message = document.createElement('h2');
    message.className = 'text-xl font-bold mb-4';
    message.textContent = winnerId === myPlayerId ? 'You won! ðŸŽ‰' : 'Someone else won ðŸ˜¢';
    popup.appendChild(message);

    // Optional: Show winning card with highlighted pattern
    const cardEl = createBingoCard(winnerCard);
    if (winningPattern) {
        winningPattern.forEach(([row, col]) => {
            const cell = cardEl.querySelector(`[data-row="${row}"][data-col="${col}"]`);
            if (cell) cell.classList.add('bg-yellow-400 text-black'); // highlight winning numbers
        });
    }
    popup.appendChild(cardEl);

    // Buttons container
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'mt-4 flex justify-around';

    // Play Again button
    const playAgainBtn = document.createElement('button');
    playAgainBtn.textContent = 'Play Again';
    playAgainBtn.className = 'px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600';
    playAgainBtn.addEventListener('click', () => {
        overlay.remove();
        cardSelectionContainer.classList.remove('hidden');
        gameBoardContainerEl.classList.add('hidden');
        generateCardSelection();
    });

    // Close button
    const closeBtn = document.createElement('button');
    closeBtn.textContent = 'Close';
    closeBtn.className = 'px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600';
    closeBtn.addEventListener('click', () =        function createBingoCard(cardData) {
            const cardWrapper = document.createElement('div');
            cardWrapper.className = `flex flex-col items-center p-4 bg-slate-800 rounded-xl shadow-lg`;

            const cardEl = document.createElement('div');
            cardEl.className = 'bingo-grid w-full';

            // Add headers
            BINGO_LETTERS.forEach(letter => {
                const header = document.createElement('div');
                header.className = 'bingo-header';
                header.textContent = letter;
                cardEl.appendChild(header);
            });

            // Add cells
            for (let i = 0; i < 5; i++) {
                for (const letter of BINGO_LETTERS) {
                    const cell = document.createElement('div');
                    const number = cardData[letter][i];
                    cell.className = 'bingo-cell';

                    if (number === 0) {
                        cell.textContent = 'Free';
                        cell.classList.add('free-space');
                    } else {
                        cell.textContent = number;
                        cell.dataset.number = number;
                    }

                    cell.addEventListener('click', () => {
                        if (cell.classList.contains('marked')) {
                            cell.classList.remove('marked');
                        } else {
                            cell.classList.add('marked');
                        }
                    });
                    cardEl.appendChild(cell);
                }
            }
            cardWrapper.appendChild(cardEl);
            return cardWrapper;
        }

        function generateBingoCard() {
            const card = { B: [], I: [], N: [], G: [], O: [] };
            const ranges = { B: [1, 15], I: [16, 30], N: [31, 45], G: [46, 60], O: [61, 75] };
            
            for (const letter of BINGO_LETTERS) {
                while (card[letter].length < 5) {
                    const [min, max] = ranges[letter];
                    const num = Math.floor(Math.random() * (max - min + 1)) + min;
                    if (!card[letter].includes(num)) {
                        card[letter].push(num);
                    }
                }
                card[letter].sort((a, b) => a - b);
            }
            
            card.N[2] = 0; // The free space
            return card;
        }

        function markNumber(number) {
            const cells = document.querySelectorAll(`.bingo-cell[data-number="${number}"]`);
            cells.forEach(cell => {
                cell.classList.add('marked');
            });

            const longBoardNumbers = document.querySelectorAll('.long-board-number');
            longBoardNumbers.forEach(el => {
                if (parseInt(el.textContent) === number) {
                    el.classList.add('marked');
                }
            });
        }

        function renderCalledNumbers(numbers) {
            longBoardEl.innerHTML = '';
            for (let i = 1; i <= 75; i++) {
                const numberEl = document.createElement('div');
                numberEl.className = 'long-board-number';
                numberEl.textContent = i;
                if (numbers.includes(i)) {
                    numberEl.classList.add('marked');
                }
                longBoardEl.appendChild(numberEl);
            }
        }

        // Populate room selection listeners
        document.querySelectorAll('.room-card').forEach(card => {
            card.addEventListener('click', () => {
                const roomId = card.dataset.room;
                currentRoomId = roomId;
                roomSelectionContainer.classList.add('hidden');
                cardSelectionContainer.classList.remove('hidden');
                generateCardSelection();
            });
        });

        function generateCardSelection() {
            cardSelectionGrid.innerHTML = '';
            allGeneratedCards = [];
            selectedCards = [];
            
            for (let i = 0; i < 100; i++) {
                const cardData = generateBingoCard();
                allGeneratedCards.push(cardData);
                const cardEl = document.createElement('div');
                cardEl.className = 'card-selection-item';
                cardEl.textContent = i + 1;
                cardEl.dataset.index = i;
                
                cardEl.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const cardData = allGeneratedCards[index];

                    if (cardEl.classList.contains('selected')) {
                        cardEl.classList.remove('selected');
                        selectedCards = selectedCards.filter(c => JSON.stringify(c) !== JSON.stringify(cardData));
                    } else if (selectedCards.length < 4) {
                        cardEl.classList.add('selected');
                        selectedCards.push(cardData);
                    }
                    cardsSelectedInfo.textContent = `${selectedCards.length}/4 cards selected`;
                    startGameBtn.disabled = selectedCards.length === 0;
                });
                cardSelectionGrid.appendChild(cardEl);
            }
        }

        startGameBtn.addEventListener('click', () => {
            if (selectedCards.length > 0 && selectedCards.length <= 4) {
                ws.send(JSON.stringify({ type: 'join_room', roomId: currentRoomId, cards: selectedCards, userId: myUserId }));
            } else {
                showMessage('Please select between 1 and 4 cards.', 'error');
            }
        });

        // Event listener for Bingo button
        bingoBtn.addEventListener('click', () => {
            if (!currentRoomId) return;
            ws.send(JSON.stringify({ type: 'claim_bingo', playerId: myPlayerId, roomId: currentRoomId }));
        });

        // Handle deposit form submission
        document.getElementById('deposit-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const amount = parseInt(document.getElementById('deposit-amount').value);
            if (isNaN(amount) || amount <= 0) {
                showMessage('Please enter a valid amount.', 'error');
                return;
            }
            ws.send(JSON.stringify({ type: 'request_deposit', amount, userId: myUserId }));
            document.getElementById('deposit-form').reset();
        });

        // Handle withdrawal form submission
        document.getElementById('withdraw-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const amount = parseInt(document.getElementById('withdraw-amount').value);
            if (isNaN(amount) || amount <= 0) {
                showMessage('Please enter a valid amount.', 'error');
                return;
            }
            ws.send(JSON.stringify({ type: 'request_withdrawal', amount, userId: myUserId }));
            document.getElementById('withdraw-form').reset();
        });

        function renderRequests(requests) {
            requestsList.innerHTML = '';
            if (requests.length === 0) {
                requestsList.innerHTML = '<li class="text-gray-400 text-center">No requests found.</li>';
                return;
            }
            requests.forEach(req => {
                const li = document.createElement('li');
                let statusColor = 'text-yellow-400';
                if (req.status === 'approved') {
                    statusColor = 'text-green-400';
                } else if (req.status === 'rejected') {
                    statusColor = 'text-red-400';
                }
                li.className = 'flex justify-between items-center p-2 bg-slate-700 rounded-lg';
                li.innerHTML = `
                    <span class="text-sm font-semibold">${req.type.toUpperCase()}</span>
                    <span class="text-sm">${req.amount}</span>
                    <span class="font-bold ${statusColor}">${req.status.toUpperCase()}</span>
                `;
                requestsList.appendChild(li);
            });
        }

        function renderAdminRequests(requests) {
            adminRequestsList.innerHTML = '';
            if (requests.length === 0) {
                adminRequestsList.innerHTML = '<li class="text-gray-400 text-center py-4">No pending requests.</li>';
                return;
            }
            requests.forEach(req => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center py-2 border-b border-slate-700 last:border-b-0';
                li.innerHTML = `
                    <div class="w-1/4 text-sm font-bold truncate">${req.type.toUpperCase()}</div>
                    <div class="w-1/4 text-sm truncate" title="${req.userId}">${req.userId}</div>
                    <div class="w-1/4 text-sm font-bold text-yellow-400">${req.amount}</div>
                    <div class="w-1/4 flex gap-2 justify-end">
                        <button class="approve-btn bg-green-500 hover:bg-green-600 text-white rounded-lg p-2 text-xs" data-request-id="${req.id}">Approve</button>
                        <button class="reject-btn bg-red-500 hover:bg-red-600 text-white rounded-lg p-2 text-xs" data-request-id="${req.id}">Reject</button>
                    </div>
                `;
                adminRequestsList.appendChild(li);
            });

            // Add event listeners to the new buttons
            document.querySelectorAll('.approve-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const requestId = e.target.dataset.requestId;
                    ws.send(JSON.stringify({ type: 'approve_request', requestId }));
                });
            });

            document.querySelectorAll('.reject-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const requestId = e.target.dataset.requestId;
                    ws.send(JSON.stringify({ type: 'reject_request', requestId }));
                });
            });
        }

        ws.onmessage = event => {
            const data = JSON.parse(event.data);
            switch(data.type) {
                case 'player_data':
                    walletBalanceEl.textContent = data.balance;
                    profileUsernameEl.textContent = `User ${data.userId.substring(5, 9)}`;
                    profileUserIdEl.textContent = `User ID: ${data.userId}`;
                    profileWinsEl.textContent = data.wins;
                    profileGamesPlayedEl.textContent = data.gamesPlayed;
                    renderRequests(data.requests);
                    break;
                case 'balance_update':
                    walletBalanceEl.textContent = data.balance;
                    break;
                case 'request_status_update':
                    ws.send(JSON.stringify({ type: 'get_player_data', userId: myUserId }));
                    if (data.status === 'approved') {
                        showMessage(`Your ${data.requestType} request for ${data.amount} has been approved.`, 'success');
                    } else if (data.status === 'rejected') {
                        showMessage(`Your ${data.requestType} request for ${data.amount} was rejected.`, 'error');
                    }
                    break;
                case 'requests_data':
                    renderAdminRequests(data.requests);
                    break;
                case 'request_action_success':
                    showMessage('Request updated successfully.', 'success');
                    ws.send(JSON.stringify({ type: 'get_admin_requests' }));
                    break;
                case 'leaderboard_data':
                    leaderboardListEl.innerHTML = '';
                    if (data.leaderboard.length === 0) {
                        leaderboardListEl.innerHTML = '<li class="text-gray-400 text-center py-4">No players on the leaderboard.</li>';
                        return;
                    }
                    data.leaderboard.forEach((player, index) => {
                        const li = document.createElement('li');
                        li.className = `flex justify-between items-center py-2 border-b border-slate-700`;
                        li.innerHTML = `
                            <span class="font-bold text-blue-400">${index + 1}.</span>
                            <span class="flex-1 ml-4 truncate">${player.username}</span>
                            <span class="font-bold text-green-400">Wins: ${player.wins}</span>
                        `;
                        leaderboardListEl.appendChild(li);
                    });
                    break;
                case 'room_status_update':
                    for (const roomId in data.room_status) {
                        const status = data.room_status[roomId];
                        const playerEl = document.querySelector(`.room-card[data-room="${roomId}"] p:nth-child(2)`);
                        if (playerEl) playerEl.textContent = `${status.players} Players`;
                        const jackpotEl = document.querySelector(`.jackpot-display[data-room="${roomId}"]`);
                        if (jackpotEl) jackpotEl.textContent = `${status.jackpot} coins`;
                        const costEl = document.querySelector(`.cost-display[data-room="${roomId}"]`);
                        if (costEl) costEl.textContent = `${status.cost}`;
                    }
                    break;
                case 'room_joined':
                    myPlayerId = data.playerId;
                    currentRoomId = data.roomId;
                    walletBalanceEl.textContent = data.balance;
                    cardSelectionContainer.classList.add('hidden');
                    gameBoardContainerEl.classList.remove('hidden');
                    gameStatusEl.textContent = 'Waiting for game to start...';
                    renderCalledNumbers([]);
                    break;

                
                // ðŸ”¹ NEW: show cards immediately when server sends them
case 'show_cards':
    myCards = data.cards;
    cardsContainerEl.innerHTML = '';
    myCards.forEach(card => {
        cardsContainerEl.appendChild(createBingoCard(card));
    });
    gameStatusEl.textContent = 'Waiting for game to start...';
    break;

                case 'game_started':
                    myCards = data.cards;
                    let numbersCalled = data.numbersCalled;
                    cardsContainerEl.innerHTML = '';
                    myCards.forEach(card => {
                        cardsContainerEl.appendChild(createBingoCard(card));
                    });
                    numbersCalled.forEach(number => markNumber(number));
                    calledNumberCircleEl.textContent = data.lastNumberCalled || '00';
                    calledNumbersCountEl.textContent = numbersCalled.length;
                    gameStatusEl.textContent = 'Game in progress!';
                    break;
                case 'number_called':
    if (!data.countdown) {
        markNumber(data.number);
        calledNumberCircleEl.textContent = data.number;
    } else {
        calledNumberCircleEl.textContent =  data.number;
    }
    calledNumbersCountEl.textContent = data.calledNumbers.length;
    break;
                case 'bingo_win':
    // Update game status for everyone
    gameStatusEl.textContent = data.winnerId === myPlayerId 
        ? 'BINGO! You won!' 
        : 'BINGO! Someone else won.';
    
    // Show a message popup
    showMessage(data.winnerId === myPlayerId 
        ? 'BINGO! You won the game!' 
        : 'Someone else called BINGO first. Better luck next time.', 
        data.winnerId === myPlayerId ? 'success' : 'error'
    );

    // Show winner popup with winning card highlighted
    showWinnerPopup(data.winnerId, data.winningCard);
    break;

case 'bingo_lose':
    gameStatusEl.textContent = 'BINGO! Someone else won.';
    showMessage('Someone else called BINGO first. Better luck next time.', 'error');
    break;

case 'invalid_bingo':
    gameStatusEl.textContent = 'Game in progress.';
    showMessage('Sorry, that is not a valid BINGO.', 'error');
    break;

case 'game_end':
    gameStatusEl.textContent = 'Game Over. No winner.';
    break;

case 'error':
    showMessage(data.message, 'error');
    break;

        // Show game page by default
        showPage('game-section');
        
        // Request initial player data
        ws.addEventListener('open', () => {
             ws.send(JSON.stringify({ type: 'get_player_data', userId: myUserId }));
             ws.send(JSON.stringify({ type: 'get_room_status' }));
        });
    </script>
</body>
</html>

